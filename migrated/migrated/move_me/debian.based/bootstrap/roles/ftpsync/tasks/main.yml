#
# The contents of this file are subject to the Apache 2.0 license you may not
# use this file except in compliance with the License.
#
# Software distributed under the License is distributed on an "AS IS" basis,
# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
# for the specific language governing rights and limitations under the
# License.
#
#
# Copyright 2014 LFFS project (http://www.linuxfirmwarefromscratch.org).  
# All rights reserved. Use is subject to license terms.
#
#
# Contributors list :
#
#    William Bonnet   wllmbnnt@gmail.com
#
#

#
# Common installation tasks to get a ftpsync up and running
#

---
# Create the ftpsync group
- name: Create the ftpsync group
  group: name={{ ftpsync_user_group }} state=present

# Add the user 'ftpsync' with a bash shell, appending the group 'ftpsync' to the user's groups
- name: Create the ftpsync user
  user: name={{ ftpsync_user_username }} shell={{ ftpsync_user_shell }} home={{ ftpsync_user_home_dir }} groups={{ ftpsync_user_group }} append=yes 

# Install the Apache Web server
- name: Install Apache web server
  apt: pkg=apache2 state=installed update_cache=true 

# Create the target directory
- name: Create target directory
  file: path={{ ftpsync_repository_dir }} state=directory mode=0775 group={{ ftpsync_user_group }}

# Download the ftpsync archive
- name: Get ftp sync and extract archive
  unarchive: src=https://ftp-master.debian.org/ftpsync.tar.gz dest=/tmp copy=no

# Copy the extract files to the ftpsync user home directory
- name: Copy the extracted files to usr/local
  command: cp -fr /tmp/distrib/{{item}} {{ ftpsync_user_home_dir }}
  with_items:
    - bin
    - etc
    - log
    - README

# Chown ownership of files in ftpsync homedir
- name: Change the ownship of ftpsync homedir files and dirs
  file: path={{ ftpsync_user_home_dir }} 
        group=ftpsync 
        owner=ftpsync 
        recurse=yes

# Clean the distrib dir from /tmp
- name: Delete the distrib dir after copying to user
  file: path=/tmp/distrib state=absent

# Copy the ftpsync main archive configuration file to target host 
- name: Copy ftpsync main archive configuration file to target host
  template: src=templates/ftpsync.conf.j2
            dest={{ ftpsync_user_home_dir }}/etc/ftpsync.conf
            owner=ftpsync 
            group=ftpsync
            mode="u=rw,g=r,o=r"          

# Copy the ftpsync backports archive configuration file to target host 
- name: Copy ftpsync backports archive configuration file to target host
  template: src=templates/ftpsynci-backports.conf.j2
            dest={{ ftpsync_user_home_dir }}/etc/ftpsync-backports.conf
            owner=ftpsync 
            group=ftpsync
            mode="u=rw,g=r,o=r"          

# Copy the ftpsync security archive configuration file to target host 
- name: Copy ftpsync security archive configuration file to target host
  template: src=templates/ftpsync-security.conf.j2
            dest={{ ftpsync_user_home_dir }}/etc/ftpsync-security.conf
            owner=ftpsync 
            group=ftpsync
            mode="u=rw,g=r,o=r"          

# Copy the ftpsync ports archive configuration file to target host 
- name: Copy ftpsync ports archive configuration file to target host
  template: src=templates/ftpsync-ports.conf.j2
            dest={{ ftpsync_user_home_dir }}/etc/ftpsync-ports.conf
            owner=ftpsync 
            group=ftpsync
            mode="u=rw,g=r,o=r"          

# Copy the synchronize_all_archives script to target host 
- name: Copy synchronize_all_archives script to target host
  copy:     src=files/synchronize_all_archives
            dest={{ ftpsync_user_home_dir }}/bin/synchronize_all_archives
            owner=ftpsync 
            group=ftpsync
            mode="u=rwx,g=rx,o=rx"          

# Copy the synchronize_all_archives configuration file to target host 
- name: Copy synchronize_all_archives configuration file to target host
  template: src=templates/synchronize_all_archives.conf.j2
            dest={{ ftpsync_user_home_dir }}/etc/synchronize_all_archives.conf
            owner=ftpsync 
            group=ftpsync
            mode="u=rw,g=r,o=r"          

# Add the destination dir to the configuration file
- name: Modify the configuration file used for synchronization TO destination dir
  lineinfile: dest={{ ftpsync_user_home_dir }}/etc/ftpsync.conf 
              state=present 
              line='TO="{{ ftpsync_repository_dir }}"'

# Add the mirror to the configuration file
- name: Modify the configuration file used for synchronization RSYNC mirror to use
  lineinfile: dest={{ ftpsync_user_home_dir }}/etc/ftpsync.conf 
              state=present 
              line="RSYNC_HOST={{ ftpsync_conf_debian_mirror }}"

# Add the EXCLUDE directive to the configuration file
- name: Modify the configuration file used for synchronization EXCLUDE
  lineinfile: dest={{ ftpsync_user_home_dir }}/etc/ftpsync.conf 
              state=present 
              line='EXCLUDE="{{ ftpsync_conf_exclude }}"' 

# Add the ARCH_ EXCLUDE directive to the configuration file
- name: Modify the configuration file used for synchronization ARCH_EXCLUDE
  lineinfile: dest={{ ftpsync_user_home_dir }}/etc/ftpsync.conf 
              state=present 
              line='ARCH_INCLUDE="{{ ftpsync_conf_arch_include }}"' 

# Add ftpsync to cron table for user ftpsync. Scheduled every 12 hours.
- cron: name="Repository update" 
        month={{ftpsync_cron_month}} 
        weekday={{ftpsync_cron_weekday}} 
        day={{ftpsync_cron_day}} 
        hour={{ftpsync_cron_hour}} 
        minute={{ftpsync_cron_minute}} 
        user="{{ ftpsync_user_username }}" 
        job="cd {{ ftpsync_user_home_dir }} && {{ ftpsync_user_home_dir }}/bin/synchronize-all-archives-with-ftpsync"

# Copy the Apache vhost configuration file to target host 
- name: Copy Apache vhost configuration file to target host
  template: src=templates/001-ftpsync-debian-mirror.conf.j2
            dest=/etc/apache2/sites-available/001-ftpsync-debian-mirror.conf
            owner=root 
            group=root 
            mode="u=rw,g=r,o=r"          

# Enable the Apache vhost
- name: Enable the Apache vhost
  command: a2ensite 001-ftpsync-debian-mirror

# Restart the Apache configuration
- name: Restart the Apache configuration
  service: name=apache2 state=restarted
