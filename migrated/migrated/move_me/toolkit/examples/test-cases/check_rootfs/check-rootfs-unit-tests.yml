#
# The contents of this file are subject to the Apache 2.0 license you may not
# use this file except in compliance with the License.
#
# Software distributed under the License is distributed on an "AS IS" basis,
# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
# for the specific language governing rights and limitations under the
# License.
#
#
# Copyright 2016 DFT project (http:/www.debianfirmwaretoolkit.org).  
# All rights reserved. Use is subject to license terms.
#
# Debian Firmware Toolkit is the new name of Linux Firmware From Scratch
# Copyright 2014 LFFS project (http:/www.linuxfirmwarefromscratch.org).  
#
#
# Contributors list :
#
#    William Bonnet     wllmbnnt@gmail.com, wbonnet@theitmakers.com
#
#

#
# The following packages definition are provided as an example of how to use 
# use packages restriction check, and are also used as one of the dft tool 
# test case
#
packages:
  #
  # Mandatory packages
  #
  mandatory:
    # This package exist and is installed 
    - name: "base-files"
      # Test is supposed to succeed
      expected-result: True
    # This package does not exist and should generate an error 
    - name: "missing-non-existent-package"
      # Test is supposed to fail
      expected-result: False
    # This package has to be installed with a constraint on minimum version 
    - name: "vim-tiny"
      min-version: "2:7.0"
      # Test is supposed to succeed
      expected-result: True
    # This package has to be installed with a constraint on maximum version
    - name: "vim-tiny"
      max-version: "2:9.0"
      # Test is supposed to succeed
      expected-result: True
    # This package has to be installed with a constraint on minimum version
    - name: "vim-tiny"
      max-version: "2:7.0"
      # Test is supposed to fail
      expected-result: False
    # This package has to be installed with a constraint on maximum version
    - name: "vim-tiny"
      min-version: "2:9.0"
      # Test is supposed to succeed
      expected-result: False
    # This package has to be installed with a given version 
    - name: "vim-common"
      allowed-version: "2:8.0.0134-1"
      # Test is supposed to succeed
      expected-result: True
    # This package has to be installed with a given version 
    - name: "vim-common"
      allowed-version: 
        - "2:8.0.0022-1"
        - "2:8.0.0134-1"
      # Test is supposed to succeed
      expected-result: True
    # This package has to be installed with a given version
    - name: "vim-common"
      allowed-version: "2:9.0"
      # Test is supposed to fail
      expected-result: False
  #
  # Forbidden packages
  #
  forbidden:
    # This package exist and is installed, thus it will output an error
    - name: "base-files"
      # Test is supposed to fail
      expected-result: False
    # This package does exist and of course is not installed
    - name: "non-installed-package"
      # Test is supposed to succeed
      expected-result: True
  #
  # Allowed packages
  #
  allowed:
    # This package is allowed and installed
    - name: "vim-tiny"
      # Test is supposed to succeed
      expected-result: True
      # This package is allowed and not installed
      # Test is supposed to succeed
      expected-result: True
    # This package is allowed and has a constraint on version
    - name: "vim-common"
      min-version: "2:7.0"
      # Test is supposed to succeed
      expected-result: True
    # This package is allowed and has a constraint on version
    - name: "vim-common"
      max-version: "2:8.1"
      # Test is supposed to succeed
      expected-result: True      
    # This package is allowed and has a constraint on version
    - name: "vim-common"
      max-version: "2:7.0"
      # Test is supposed to fail
      expected-result: False
    # This package is allowed and has a constraint on version
    - name: "vim-common"
      min-version: "2:9.0"
      # Test is supposed to fail
      expected-result: False
    # This package is allowed and has several constraints on version
    - name: "vim-common"
      min-version: "2:7.0"
      max-version: "2:9.0"
      # Test is supposed to succeed
      expected-result: True
    # This package is allowed and has several constraints on version
    - name: "vim-common"
      min-version: "9"
      max-version: "7"
      # Test is supposed to fail
      expected-result: False
    # This package is allowed and has constraints on given versions, it
    # should succeed. But it may fails depending on the Debian version
    # you use ;) just change versions
    - name: "vim-common"
      allowed-version: 
        - "2:8.0.0134-1"
        - "2:8.0.0022-1"
      # Test is supposed to succeed
      expected-result: True
    # This package is allowed and has constraints on given versions, it
    # should not succeed since none of the version are valid.
    - name: "vim-common"
      allowed-version: 
        - "2:7.0"
        - "2:7.1"
      # Test is supposed to succeed
      expected-result: False
    # This package is allowed and has constraints on given blacklisted
    # versions, it should succeed.
    - name: "vim-common"
      blacklisted-version: 
        - "2:9.0.0134-1"
        - "2:9.0.0022-1"
      # Test is supposed to succeed
      expected-result: True
    # This package is allowed and has constraints on given blacklisted
    # versions, it should fail.
    - name: "vim-common"
      blacklisted-version: 
        - "2:9.0.0134-1"
        - "2:9.0.0022-1"
      # Test is supposed to fail
      expected-result: False
    # This package is allowed and has constraints on blacklisted arch,
    # it should succeed
    - name: "vim-common"
      blacklisted-arch:
        - "arm64"
      # Test is supposed to succeed
      expected-result: True
    # This package is allowed and has several constraints on blacklisted 
    # arch, it should succeed
    - name: "vim-common"
      blacklisted-arch:
        - "arm64"
        - "armhf"
        - "armel"
      # Test is supposed to succeed
      expected-result: True
    # This package is allowed and has constraints on blacklisted arch,
    # it should fail
    - name: "vim-common"
      blacklisted-arch:
        - "all"
      # Test is supposed to fail
      expected-result: False
    # This package is allowed and has several constraints on blacklisted
    # arch, it should fail
    - name: "vim-common"
      blacklisted-arch:
        - "amd64"
        - "all"
        - "arm64"
      # Test is supposed to fail
      expected-result: False
    # This package is allowed on several arch but not amd64 it should fail 
    - name: "base-files"
      allowed-arch:
        - "all"
        - "armhf"
      # Test is supposed to fail
      expected-result: False
    # This package is allowed on amd64 it should succeed
    - name: "base-files"
      allowed-arch:
        - "amd64"
        - "armhf"
      # Test is supposed to succeed
      expected-result: True
# TODO handle regex on versions
#
# The following section defines the list of files and their restriction.
#
files:
  #
  # Mandatory objects
  #
  mandatory:
    #
    # Files
    #
    # Mandatory single file
  - path: "/dft/unittests/existing/empty-file"
    # Test is supposed to succeed
    expected-result: True
    # Object with an unknow type
  - path: "/dft/unittests/existing/var/"
    type: "unknown"
    # Test is supposed to fail
    expected-result: False
    # Mandatory non existing file
  - path: "/dft/unittests/misssing/empty-file"
    # Test is supposed to fail
    expected-result: False
    # Mandatory file but it is a directory
  - path: "/dft/unittests/existing/etc"
    type: "file"
    # Test is supposed to fail
    expected-result: False  
    # Mandatory single but it is a symlink
  - path: "/dft/unittests/existing/link"
    type: "file"
    # Test is supposed to fail
    expected-result: False
    # File with valid type owner group and mode
  - path: "/dft/unittests/existing/etc/passwd"
    type: "file"
    owner: "root"
    group: "root"
    mode: "0644"
    # Test is supposed to succeed
    expected-result: True
    # This definition will produce an error on file attributes
  - path: "/dft/unittests/existing/etc/passwd"
    owner: "root"
    group: "root"
    mode: "0666"
    # Test is supposed to fail
    expected-result: False
    # This definition will produce an error on group
  - path: "/dft/unittests/existing/etc/passwd"
    owner: "root"
    group: "staff"
    mode: "0640"
    # Test is supposed to fail
    expected-result: False
    # This definition will produce an error on owner
  - path: "/dft/unittests/existing/etc/passwd"
    owner: "dft"
    group: "root"
    mode: "0640"
    # Test is supposed to fail
    expected-result: False
    # This definition will produce an error on everything
  - path: "/dft/unittests/existing/etc/passwd"
    owner: "dft"
    group: "dft"
    mode: "0666"
    # Test is supposed to fail
    expected-result: False
#TODO check for sticky bits etc/
    #
    # Directories
    #
    # Mandatory directory
  - path: "/dft/unittests/existing/etc/"
    type: "directory"
    # Test is supposed to succeed
    expected-result: True
    # Unreadable missing object
  - path: "/dft/unittests/missing/does-not exist"
    type: "directory"
    # Test is supposed to fail
    expected-result: False
    # Mandatory directory, but it is a file
  - path: "/dft/unittests/existing/etc/passwd"
    type: "directory"
    # Test is supposed to fail
    expected-result: False
    # Mandatory directory, but it is a symlink
  - path: "/dft/unittests/existing/link"
    type: "directory"
    # Test is supposed to fail
    expected-result: False
    # Directory with valid type owner group and mode
  - path: "/dft/unittests/existing/etc/network"
    type: "directory"
    owner: "root"
    group: "root"
    mode: "0644"
    # Test is supposed to succeed
    expected-result: True
    # Directory with invalid type owner group and mode
  - path: "/dft/unittests/existing/etc/network"
    type: "directory"
    owner: "dft"
    group: "dft"
    mode: "0777"
    # Test is supposed to fail
    expected-result: False
    #
    # Symlinks
    #
    # Existing symlink without target nor type
  - path: "/dft/unittests/existing/link"
    # Test is supposed to succeed
    expected-result: True
    # Existing symlink without target
  - path: "/dft/unittests/existing/link"
    type: "symlink"
    # Test is supposed to succeed
    expected-result: True
    # Existing symlink with existing target
  - path: "/dft/unittests/existing/link"
    type: "symlink"
    target: "/dft/unittests/existing/link-target"
    # Test is supposed to succeed
    expected-result: True
    # Existing symlink with existing target and without type
  - path: "/dft/unittests/existing/link"
    target: "/dft/unittests/existing/link-target"
    # Test is supposed to succeed
    expected-result: True
    # Existing symlink with missing target
  - path: "/dft/unittests/existing/link"
    type: "symlink"
    target: "/lib/systemd/system/ssh.service.missing"
    # Test is supposed to fail
    expected-result: False
    # Existing symlink with missing target and without type
  - path: "/dft/unittests/existing/link"
    target: "/lib/systemd/system/ssh.service.missing"
    # Test is supposed to fail
    expected-result: False
    # This test will succeed since the target does not exist and its forbidden
  - path: "/dft/unittests/existing/etc/systemd/system/sshd.service"
    type: "symlink"
    target: "/lib/systemd/system/ssh.service"
  # 
  # Forbidden objects
  #
  forbidden:
  #
  # Files
  #
  # This file exist but is forbidden, without type it defaults to a file
  - path: "/dft/unittests/existing/etc/passwd"
    # Test is supposed to fail
    expected-result: False
  # This file does not and is forbidden
  - path: "/dft/unittests/missing/not-existing"
    # Test is supposed to succeed
    expected-result: True
  # This file does not and is forbidden
  - path: "/dft/unittests/missing/not-existing"
    type: "file"
    # Test is supposed to succeed
    expected-result: True
  #
  # The following test cases ar using type information. If type is set then
  # the object is forbidden only as an object of the givn type. If you want
  # this path to be forbidden whatever is the type, dont set the type :)
  # This file exist but is forbidden, with type info => file
  #
  - path: "/dft/unittests/existing/etc/passwd"
    type: "file"
    # Test is supposed to fail
    expected-result: False
  # This file exist but is forbidden as a directory (authorized otherwise)
  - path: "/dft/unittests/existing/etc/passwd"
    type: "directory"
    # Test is supposed to succeed
    expected-result: True
  # This file exist but is forbidden as a symlink (authorized otherwise)
  - path: "/dft/unittests/existing/etc/passwd"
    type: "symlink"
    # Test is supposed to succeed
    expected-result: True
  #
  # Directory
  #
  # This diretory does not and is forbidden
  - path: "/dft/unittests/missing/not-existing"
    type: "directory"
    # Test is supposed to succeed
    expected-result: True
  #
  # The following test cases ar using type information. If type is set then
  # the object is forbidden only as an object of the givn type. If you want
  # this path to be forbidden whatever is the type, dont set the type :)
  # This dir exist but is forbidden
  #
  - path: "/dft/unittests/existing/etc/"
    type: "file"
    # Test is supposed to succeed
    expected-result: True
  # This dir exist but is forbidden as a directory (authorized otherwise)
  - path: "/dft/unittests/existing/etc"
    type: "directory"
    # Test is supposed to fail
    expected-result: False
  # This dir exist but is forbidden as a symlink (authorized otherwise)
  - path: "/dft/unittests/existing/etc/passwd"
    type: "symlink"
    # Test is supposed to succeed
    expected-result: True
  #
  # Symlinks
  #
  # This diretory does not and is forbidden
  - path: "/dft/unittests/missing/not-existing"
    type: "symlink"
    # Test is supposed to succeed
    expected-result: True
  #
  # The following test cases ar using type information. If type is set then
  # the object is forbidden only as an object of the givn type. If you want
  # this path to be forbidden whatever is the type, dont set the type :)
  # This link exist but is forbidden
  #
  - path: "/dft/unittests/existing/etc/passwd"
    type: "file"
    # Test is supposed to succeed
    expected-result: True
  # This link exist but is forbidden as a directory (authorized otherwise)
  - path: "/dft/unittests/existing/etc/passwd"
    type: "dirctory"
    # Test is supposed to succeed
    expected-result: True
  # This file exist but is forbidden as a symlink (authorized otherwise)
  - path: "/dft/unittests/existing/etc/passwd"
    type: "symlink"
    # Test is supposed to fail
    expected-result: False
  # This link point is forbidden. Since the target exist, the target becomes
  # forbidden (link target not file itself). If you need to test the link not
  # its target, do not specify atarget value.
  - path: "/dft/unittests/existing/link"
    type: "symlink"
    target: "link-target"
    # Test is supposed to fail
    expected-result: False
  # This link point is forbidden. Even if the target does not exist, the 
  # target becomes forbidden (link target not file itself)
  - path: "/dft/unittests/existing/link"
    type: "symlink"
    target: "link-target-does-not exist"
    # Test is supposed to succeed
    expected-result: True
  #
  # Allowed objects
  #
  allowed:
    #
    # Files
    #
  # Test that a file is not empty (not type means file by efault)
  - path: "/dft/unittests/existing/empty-file"
    empty: False
    # Test is supposed to fail
    expected-result: False
  # Test that a file is not empty (not type means file by efault)
  - path: "/dft/unittests/existing/non-empty-file"
    empty: False
    # Test is supposed to succeed
    expected-result: True
  # Test that a file is empty (not type means file by efault)
  - path: "/dft/unittests/existing/empty-file"
    empty: True
    # Test is supposed to succeed
    expected-result: True
  # Test that a file is empty (not type means file by efault)
  - path: "/dft/unittests/existing/non-empty-file"
    empty: True
    # Test is supposed to fail
    expected-result: False
  # Test the md5 sum of a file
  - path: "/dft/unittests/existing/non-empty-file"
    md5sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the md5 sum of a file
  - path: "/dft/unittests/existing/non-empty-file"
    md5sum: "570a5adf1578c95aa27207632c74dacd"
    # Test is supposed to fail
    expected-result: True
  # Test the sha1 sum of a file
  - path: "/dft/unittests/existing/non-empty-file"
    sha1sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the sha1 sum of a file
  - path: "/dft/unittests/existing/non-empty-file"
    sa1sum: "99b6f3cb04c2b9f027928869a2a1872ef4fe3246"
    # Test is supposed to fail
    expected-result: True
  # Test the sha256 sum of a file
  - path: "/dft/unittests/existing/non-empty-file"
    sha256sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the sha256 sum of a file
  - path: "/dft/unittests/existing/non-empty-file"
    sha256sum: "d1cfe74689e00a44e66f743c57fe7a0fa622f9b560ee8fabc7adc332edaf0941"
    # Test is supposed to fail
    expected-result: True
  # Test the md5 sum of a directory
  - path: "/dft/unittests/etc"
    md5sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the sha1 sum of a directory
  - path: "/dft/unittests/etc"
    sha1sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the sha256 sum of a directory
  - path: "/dft/unittests/existing/non-empty-file"
    sha256sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the md5 sum of a directory without type, thus a file
  - path: "/dft/unittests/existing/etc"
    md5sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the md5 sum of a diretory without type, thus a file
  - path: "/dft/unittests/existing/etc"
    sha1sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
    # Test the md5 sum of a directory without type, thus a file
  - path: "/dft/unittests/existing/etc"
    sha256sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
    #
    # Directories
    #
    # Test the md5 sum of a directory without type, thus a file
  - path: "/dft/unittests/missing/etc"
    type: "directory"
    # Test is supposed to succeed since missing but optional
    expected-result: True
    #
    # Symlinks
    #
  # Test the md5 sum of a symlink without type, thus a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    md5sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the md5 sum of a symlink without type, thus a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    sha1sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
    # Test the md5 sum of a symlink without type, thus a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    sha256sum: "very_unlikely_hash_value"
    # Test is supposed to fail
    expected-result: False
  # Test the md5 sum of a link to a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    md5sum: "very_unlikely_hash_value"
    type: "symlink"
    # Test is supposed to fail
    expected-result: False
  # Test the md5 sum of a link to a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    md5sum: "570a5adf1578c95aa27207632c74dacd"
    type: "symlink"
    # Test is supposed to fail
    expected-result: True
  # Test the sha1 sum of a link to a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    sha1sum: "very_unlikely_hash_value"
    type: "symlink"
    # Test is supposed to fail
    expected-result: False
  # Test the sha1 sum of a link to a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    sa1sum: "99b6f3cb04c2b9f027928869a2a1872ef4fe3246"
    type: "symlink"
    # Test is supposed to fail
    expected-result: True
  # Test the sha256 sum of a link to a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    sha256sum: "very_unlikely_hash_value"
    type: "symlink"
    # Test is supposed to fail
    expected-result: False
  # Test the sha256 sum of a link to a file
  - path: "/dft/unittests/existing/link-to-non-empty-file"
    sha256sum: "d1cfe74689e00a44e66f743c57fe7a0fa622f9b560ee8fabc7adc332edaf0941"
    type: "symlink"
    # Test is supposed to fail
    expected-result: True


# TODO : regexp for files and dirs
# TODO : should i check for multiple definitions ?
# TODO : contains ?
# TODO : add unit tests on sticky bit